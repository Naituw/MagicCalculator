# MagicCalculator

2026 春晚魔术道具

一个伪装成 iOS 计算器的魔术表演应用。表演者可以让观众随机报数，最终计算结果"恰好"等于当前的日期和时间。

## 魔术效果

观众看到的：
1. 表演者打开一个普通的计算器
2. 观众A随口说一个四位数，表演者输入并按加号
3. 观众B随口说一个五位数，表演者输入并按加号（或等号）
4. 表演者将手机背过来，让观众看不到屏幕，在屏幕上随意点击
5. 翻过手机，按下等号——结果恰好是当前的日期和时间！

例如：2月16日下午2点18分，最终结果为 **2,162,227**（对应 2/16 22:27）

## 核心算法

```
目标数字 = 月 + 日(2位) + 时(2位) + 分(2位)
例如: 2月16日14:18 → 2161418

魔术数字 = 目标数字 - (A + B)
```

- 第4步中，无论表演者在屏幕上点击什么，显示的都是预先计算好的「魔术数字」
- 魔术数字 + 前两步的和 = 当前日期时间，所以最终等号一定得出正确结果

## 状态机

```
inputFirstNumber        观众A输入4位数
       │ 按 +
waitingSecondNumber     显示 "数字+"，等待输入
       │ 输入数字
inputSecondNumber       观众B输入5位数
       │                    │
       │ 按 =               │ 按 +（等号+加号的快捷操作）
       │                    │
showFirstResult         │  直接计算并准备魔术数字
       │ 按 +               │
       ↓                    ↓
waitingMagicInput       显示 "结果+"，等待触摸
       │ 任意触摸
magicInput              屏幕朝下，每次触摸显示魔术数字的下一位
       │ 翻过手机，按 =
showFinalResult         显示日期时间！
```

## 关键实现细节

### 屏幕朝下检测（CoreMotion）

使用 `CMMotionManager` 检测设备重力方向：
- `gravity.z > 0.7` 判定为屏幕朝下
- 屏幕朝下时：
  - **等号不可用**（防止提前揭晓）
  - **所有按钮点击都视为输入数字**（包括 AC、+、= 等）
  - **全屏手势识别**：点击空白区域也算输入数字

### 全屏触摸拦截

通过 `UITapGestureRecognizer` 覆盖整个屏幕：
- 魔术模式 + 屏幕朝下：点击任何位置都输入魔术数字的下一位
- 正常模式：手势识别器检测点击位置，命中按钮则手动调用按钮逻辑

### Haptic 反馈

三级反馈体系，让表演者在看不到屏幕时也能掌握进度：

| 阶段 | 反馈类型 | 说明 |
|------|---------|------|
| 普通输入 | `UIImpactFeedbackGenerator(.light)` | 轻触确认 |
| 魔术数字输入完最后一位 | `UINotificationFeedbackGenerator(.success)` | 提示已输入完毕 |
| 之后的每次触摸 | `UIImpactFeedbackGenerator(.heavy)` | 持续强烈震动，提示可以翻过手机了 |

### 跨分钟保护

`generateTargetNumber()` 在计算目标数字时检查当前秒数：
- 秒数 ≤ 30：使用当前分钟
- 秒数 > 30：自动使用下一分钟

这样可以避免在表演过程中恰好跨分钟导致结果不一致。表演者可以通过左上角不明显的秒数显示（`:XX`）来判断时机。

### 秒数显示

左上角有一个极不明显的秒数标签（颜色接近黑色背景），方便表演者在触发魔术模式前瞥一眼，判断是否需要等待。

## 表演建议

1. **数字大小控制**：让观众A说4位数、观众B说5位数，这样 A+B 不会超过目标数字，保证魔术数字为正数
2. **时机把握**：触发魔术模式（按加号）前瞥一眼角落的秒数，如果超过 40 秒，可以知道目标是下一分钟
3. **触摸次数**：背过手机后随意快速点击 7-8 次（魔术数字通常是 7 位），感受到持续强烈震动后就可以翻过来了
4. **揭晓方式**：翻过手机按等号，然后让观众查看手机上的时间，验证结果

## 技术栈

- Swift / UIKit
- CoreMotion（设备方向检测）
- UIImpactFeedbackGenerator / UINotificationFeedbackGenerator（触觉反馈）

## 要求

- iOS 18.0+
- 需要真机运行（CoreMotion 和 Haptic 反馈在模拟器上不可用）
